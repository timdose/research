extends layout

block content
  h1 Pronunciation Survey


  form(method="POST",action="/save-details")
    .field-group
      label Mechanical Turk ID
      <input type="text" id="worker-id" name="worker-id"></input>

    .field-group
      <img class="question-image" src="/images/default.png">
      label How would you pronounce this name?
      .note
        .text Please record yourself and upload an audio file. Only .wma, .m4a, .mp3, and .wav files will be accepted.
        <input type="file" id="file-input">

    .field-group
      label How confident are you that you pronounced the name above correctly?
      .likert-group
        .likert-items
          label.likert-item
            .text 1
            <input type="radio" name="confidence" value="1">
          label.likert-item
            .text 2
            <input type="radio" name="confidence" value="2">
          label.likert-item
            .text 3
            <input type="radio" name="confidence" value="3">
          label.likert-item
            .text 4
            <input type="radio" name="confidence" value="4">
          label.likert-item
            .text 5
            <input type="radio" name="confidence" value="5">
        .likert-labels
            .likert-label.low Not confident at all
            .likert-label.high Very confident

    .field-group
      <input type="submit" value="Submit">

  script.
    (() => {
      document.getElementById("file-input").onchange = () => {
        const files = document.getElementById('file-input').files;
        const file = files[0];
        if(file == null){
          return alert('No file selected.');
        }
        getSignedRequest(file);
      };

      function getSignedRequest(file){
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/sign-s3?file-name=${file.name}&file-type=${file.type}`);
        xhr.onreadystatechange = () => {
          if(xhr.readyState === 4){
            if(xhr.status === 200){
              const response = JSON.parse(xhr.responseText);
              uploadFile(file, response.signedRequest, response.url);
            }
            else{
              alert('Could not get signed URL.');
            }
          }
        };
        xhr.send();
      }

      function uploadFile(file, signedRequest, url){
        const xhr = new XMLHttpRequest();
        xhr.open('PUT', signedRequest);
        xhr.onreadystatechange = () => {
          if(xhr.readyState === 4){
            if(xhr.status === 200){
              document.getElementById('preview').src = url;
              document.getElementById('avatar-url').value = url;
            }
            else{
              alert('Could not upload file.');
            }
          }
        };
        xhr.send(file);
      }


    })();


